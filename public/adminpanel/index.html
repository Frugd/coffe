<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Brew & Bean ‚Äî –ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å</title>
  <style>
/* ===== RESET ===== */
*,*::before,*::after{margin:0;padding:0;box-sizing:border-box}
html{scroll-behavior:smooth}
body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,'Helvetica Neue',Arial,sans-serif;color:#1a1a1a;background:#f5f5f4;line-height:1.6;-webkit-font-smoothing:antialiased}
a{text-decoration:none;color:inherit}
button{cursor:pointer;border:none;background:none;font:inherit}
input,textarea,select{font:inherit}
::-webkit-scrollbar{width:6px;height:6px}
::-webkit-scrollbar-track{background:transparent}
::-webkit-scrollbar-thumb{background:#d6d3d1;border-radius:10px}

/* ===== LAYOUT ===== */
.app{display:flex;min-height:100vh}

/* ===== SIDEBAR ===== */
.sidebar{width:260px;background:#1c1917;color:#fff;display:flex;flex-direction:column;position:fixed;top:0;left:0;bottom:0;z-index:50;transition:transform .3s}
.sidebar-header{padding:20px 24px;border-bottom:1px solid rgba(255,255,255,.08)}
.sidebar-logo{display:flex;align-items:center;gap:10px;font-size:18px;font-weight:800}
.sidebar-logo .icon{width:36px;height:36px;border-radius:10px;background:#92400e;display:flex;align-items:center;justify-content:center;font-size:16px}
.sidebar-logo em{font-style:normal;color:#d97706}
.sidebar-sub{font-size:11px;color:#666;margin-top:4px}
.sidebar-nav{flex:1;padding:16px 12px;overflow-y:auto}
.nav-section{font-size:10px;text-transform:uppercase;letter-spacing:1.5px;color:#555;padding:12px 12px 8px;font-weight:600}
.nav-item{display:flex;align-items:center;gap:12px;padding:10px 16px;border-radius:10px;font-size:14px;font-weight:500;color:#a8a29e;transition:all .2s;margin-bottom:2px;cursor:pointer}
.nav-item:hover{background:rgba(255,255,255,.05);color:#fff}
.nav-item.active{background:#92400e;color:#fff;box-shadow:0 4px 16px rgba(146,64,14,.3)}
.nav-item .emoji{font-size:18px;width:24px;text-align:center}
.nav-item .badge{margin-left:auto;padding:2px 8px;border-radius:50px;font-size:10px;font-weight:700;background:rgba(239,68,68,.2);color:#ef4444}
.sidebar-footer{padding:16px 20px;border-top:1px solid rgba(255,255,255,.08)}
.sidebar-footer a{display:flex;align-items:center;gap:8px;font-size:13px;color:#888;transition:color .2s;padding:8px 0}
.sidebar-footer a:hover{color:#d97706}

/* ===== MOBILE SIDEBAR ===== */
.sidebar-overlay{display:none;position:fixed;inset:0;background:rgba(0,0,0,.5);z-index:40}
.sidebar-overlay.show{display:block}
.mobile-header{display:none;position:fixed;top:0;left:0;right:0;z-index:30;background:#fff;padding:12px 16px;border-bottom:1px solid #e5e2de;align-items:center;gap:12px}
.mobile-header .burger{width:40px;height:40px;border-radius:8px;display:flex;align-items:center;justify-content:center;font-size:20px;color:#555;background:none;border:none;cursor:pointer}
.mobile-header .title{font-size:16px;font-weight:700}
@media(max-width:768px){
  .sidebar{transform:translateX(-100%)}
  .sidebar.open{transform:translateX(0)}
  .mobile-header{display:flex}
  .main{margin-left:0!important;padding-top:72px!important}
}

/* ===== MAIN ===== */
.main{flex:1;margin-left:260px;padding:32px}
.page{display:none}
.page.active{display:block}
.page-header{margin-bottom:32px}
.page-header h1{font-size:28px;font-weight:800;margin-bottom:4px}
.page-header p{font-size:14px;color:#888}
.page-actions{display:flex;gap:12px;margin-top:16px;flex-wrap:wrap}

/* ===== CARDS ===== */
.stats-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(220px,1fr));gap:16px;margin-bottom:32px}
.stat-card{padding:24px;border-radius:14px;background:#fff;border:1px solid #f0eeeb;transition:all .3s}
.stat-card:hover{box-shadow:0 8px 24px rgba(0,0,0,.06);transform:translateY(-2px)}
.stat-card .top{display:flex;align-items:center;justify-content:space-between;margin-bottom:12px}
.stat-card .icon{width:44px;height:44px;border-radius:12px;display:flex;align-items:center;justify-content:center;font-size:20px}
.stat-card .icon.amber{background:#fffbeb}
.stat-card .icon.green{background:#f0fdf4}
.stat-card .icon.blue{background:#eff6ff}
.stat-card .icon.red{background:#fef2f2}
.stat-card .icon.purple{background:#faf5ff}
.stat-card .change{font-size:11px;font-weight:600;padding:3px 10px;border-radius:50px}
.stat-card .change.up{background:#f0fdf4;color:#16a34a}
.stat-card .change.down{background:#fef2f2;color:#ef4444}
.stat-card h3{font-size:28px;font-weight:800}
.stat-card .label{font-size:12px;color:#888;margin-top:4px}

/* ===== TABLE ===== */
.table-wrap{background:#fff;border-radius:14px;border:1px solid #f0eeeb;overflow:hidden}
.table-header{display:flex;align-items:center;justify-content:space-between;padding:16px 20px;border-bottom:1px solid #f0eeeb;flex-wrap:wrap;gap:12px}
.table-header h3{font-size:16px;font-weight:700}
.table-header .tools{display:flex;gap:8px;align-items:center}
.search-input{padding:8px 14px;border-radius:8px;border:1px solid #e5e2de;background:#fafaf9;font-size:13px;outline:none;width:220px;transition:border-color .2s}
.search-input:focus{border-color:#d97706}
.table-scroll{overflow-x:auto}
table{width:100%;border-collapse:collapse;min-width:600px}
thead{background:#fafaf9}
th{padding:12px 16px;font-size:11px;font-weight:700;color:#888;text-transform:uppercase;letter-spacing:.5px;text-align:left;border-bottom:1px solid #f0eeeb;white-space:nowrap}
td{padding:12px 16px;font-size:13px;border-bottom:1px solid #f5f5f4;vertical-align:middle}
tr:hover td{background:#fafaf9}
.table-empty{padding:40px;text-align:center;color:#aaa;font-size:14px}

/* ===== STATUS BADGES ===== */
.status{display:inline-block;padding:3px 12px;border-radius:50px;font-size:11px;font-weight:600}
.status.green{background:#f0fdf4;color:#16a34a}
.status.yellow{background:#fffbeb;color:#d97706}
.status.red{background:#fef2f2;color:#ef4444}
.status.blue{background:#eff6ff;color:#2563eb}
.status.gray{background:#f5f5f4;color:#888}
.status.purple{background:#faf5ff;color:#9333ea}

/* ===== BUTTONS ===== */
.btn{display:inline-flex;align-items:center;gap:6px;padding:9px 18px;border-radius:8px;font-size:13px;font-weight:600;transition:all .2s;white-space:nowrap;cursor:pointer;border:none}
.btn-primary{background:#92400e;color:#fff}
.btn-primary:hover{background:#78350f}
.btn-success{background:#16a34a;color:#fff}
.btn-success:hover{background:#15803d}
.btn-danger{background:#ef4444;color:#fff}
.btn-danger:hover{background:#dc2626}
.btn-outline{background:#fff;color:#555;border:1px solid #e5e2de}
.btn-outline:hover{border-color:#d97706;color:#92400e}
.btn-sm{padding:5px 12px;font-size:11px;border-radius:6px}
.btn-icon{width:32px;height:32px;padding:0;display:flex;align-items:center;justify-content:center;border-radius:8px;font-size:14px;background:#fff;border:1px solid #e5e2de;color:#888;transition:all .2s}
.btn-icon:hover{border-color:#d97706;color:#92400e}
.btn-icon.danger:hover{border-color:#ef4444;color:#ef4444}
.actions-cell{display:flex;gap:6px}

/* ===== MODAL ===== */
.modal-overlay{display:none;position:fixed;inset:0;background:rgba(0,0,0,.4);z-index:100;align-items:center;justify-content:center;padding:24px}
.modal-overlay.open{display:flex}
.modal{background:#fff;border-radius:16px;width:100%;max-width:560px;max-height:calc(100vh - 48px);overflow-y:auto;box-shadow:0 24px 64px rgba(0,0,0,.15)}
.modal-head{display:flex;align-items:center;justify-content:space-between;padding:20px 24px;border-bottom:1px solid #f0eeeb}
.modal-head h3{font-size:18px;font-weight:700}
.modal-close{width:32px;height:32px;border-radius:8px;display:flex;align-items:center;justify-content:center;font-size:18px;color:#888;transition:all .2s;cursor:pointer;background:none;border:none}
.modal-close:hover{background:#f5f5f4;color:#333}
.modal-body{padding:24px}
.modal-footer{display:flex;gap:12px;justify-content:flex-end;padding:16px 24px;border-top:1px solid #f0eeeb}

/* ===== FORMS ===== */
.form-group{margin-bottom:16px}
.form-group label{display:block;font-size:12px;font-weight:600;color:#555;margin-bottom:6px}
.form-group input,.form-group select,.form-group textarea{width:100%;padding:10px 14px;border-radius:8px;border:1px solid #e5e2de;background:#fafaf9;font-size:13px;outline:none;transition:all .2s}
.form-group input:focus,.form-group select:focus,.form-group textarea:focus{border-color:#d97706;background:#fff}
.form-group textarea{resize:vertical;min-height:60px}
.form-row{display:grid;grid-template-columns:1fr 1fr;gap:16px}
@media(max-width:480px){.form-row{grid-template-columns:1fr}}
.form-hint{font-size:11px;color:#aaa;margin-top:4px}

/* ===== TABS ===== */
.tabs{display:flex;gap:4px;margin-bottom:24px;border-bottom:2px solid #f0eeeb;padding-bottom:0}
.tab{padding:10px 20px;font-size:13px;font-weight:600;color:#888;border-bottom:2px solid transparent;margin-bottom:-2px;transition:all .2s;cursor:pointer;background:none;border-top:none;border-left:none;border-right:none}
.tab:hover{color:#92400e}
.tab.active{color:#92400e;border-bottom-color:#92400e}
.tab-content{display:none}
.tab-content.active{display:block}

/* ===== AI CONFIG PANEL ===== */
.config-panel{background:#fff;border-radius:14px;border:1px solid #f0eeeb;padding:24px;margin-bottom:24px}
.config-panel h3{font-size:16px;font-weight:700;margin-bottom:16px}
.config-row{display:flex;align-items:center;gap:12px;padding:12px 0;border-bottom:1px solid #f5f5f4}
.config-row:last-child{border-bottom:none}
.config-row label{font-size:13px;font-weight:600;min-width:120px}
.config-row input,.config-row select{flex:1;padding:8px 12px;border-radius:8px;border:1px solid #e5e2de;font-size:13px;outline:none}
.config-row input:focus{border-color:#d97706}

/* ===== DELIVERY STATUS TIMELINE ===== */
.timeline{display:flex;gap:4px;align-items:center}
.timeline-step{display:flex;align-items:center;gap:4px}
.timeline-dot{width:20px;height:20px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:10px;border:2px solid #e5e2de;color:#ccc;background:#fff}
.timeline-dot.done{border-color:#16a34a;background:#16a34a;color:#fff}
.timeline-dot.current{border-color:#d97706;background:#fffbeb;color:#d97706}
.timeline-line{width:16px;height:2px;background:#e5e2de}
.timeline-line.done{background:#16a34a}

/* ===== MISC ===== */
.text-right{text-align:right}
.text-center{text-align:center}
.text-muted{color:#888}
.text-bold{font-weight:700}
.text-amber{color:#92400e}
.mt-16{margin-top:16px}
.mt-24{margin-top:24px}
.mb-16{margin-bottom:16px}
.mb-24{margin-bottom:24px}
.flex{display:flex}
.flex-wrap{flex-wrap:wrap}
.gap-8{gap:8px}
.gap-12{gap:12px}
.items-center{align-items:center}
.justify-between{justify-content:space-between}

/* ===== NOTIFICATION ===== */
.toast{position:fixed;top:20px;right:20px;z-index:200;padding:14px 24px;border-radius:10px;font-size:13px;font-weight:600;color:#fff;box-shadow:0 8px 30px rgba(0,0,0,.15);transform:translateX(120%);transition:transform .3s;display:flex;align-items:center;gap:8px}
.toast.show{transform:translateX(0)}
.toast.success{background:#16a34a}
.toast.error{background:#ef4444}
.toast.info{background:#2563eb}

/* ===== PRINT ===== */
@media print{
  .sidebar,.mobile-header,.page-actions,.btn,.modal-overlay,.toast,.sidebar-overlay{display:none!important}
  .main{margin-left:0!important;padding:16px!important}
  .table-wrap{border:1px solid #ccc}
}
  </style>
</head>
<body>

<!-- Toast notification -->
<div class="toast" id="toast"></div>

<!-- Mobile header -->
<div class="mobile-header">
  <button class="burger" id="burgerBtn">‚ò∞</button>
  <span class="title">‚òï –ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å</span>
</div>
<div class="sidebar-overlay" id="sidebarOverlay"></div>

<div class="app">

<!-- ==================== SIDEBAR ==================== -->
<aside class="sidebar" id="sidebar">
  <div class="sidebar-header">
    <div class="sidebar-logo">
      <div class="icon">‚òï</div>
      Brew <em>&</em> Bean
    </div>
    <div class="sidebar-sub">–ü–∞–Ω–µ–ª—å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è</div>
  </div>
  <nav class="sidebar-nav">
    <div class="nav-section">–û—Å–Ω–æ–≤–Ω–æ–µ</div>
    <div class="nav-item active" data-page="dashboard"><span class="emoji">üìä</span> –î–∞—à–±–æ—Ä–¥</div>
    <div class="nav-item" data-page="products"><span class="emoji">üì¶</span> –¢–æ–≤–∞—Ä—ã</div>
    <div class="nav-item" data-page="sales"><span class="emoji">üí∞</span> –ü—Ä–æ–¥–∞–∂–∏</div>
    <div class="nav-item" data-page="delivery"><span class="emoji">üöó</span> –î–æ—Å—Ç–∞–≤–∫–∞ <span class="badge" id="deliveryBadge"></span></div>
    <div class="nav-section">–ù–∞—Å—Ç—Ä–æ–π–∫–∏</div>
    <div class="nav-item" data-page="settings"><span class="emoji">‚öôÔ∏è</span> –ù–∞—Å—Ç—Ä–æ–π–∫–∏ AI</div>
  </nav>
  <div class="sidebar-footer">
    <a href="../">‚Üê –í–µ—Ä–Ω—É—Ç—å—Å—è –Ω–∞ —Å–∞–π—Ç</a>
  </div>
</aside>

<!-- ==================== MAIN CONTENT ==================== -->
<main class="main">

<!-- ===== DASHBOARD ===== -->
<div class="page active" id="page-dashboard">
  <div class="page-header">
    <h1>üìä –î–∞—à–±–æ—Ä–¥</h1>
    <p>–û–±–∑–æ—Ä –ø–æ–∫–∞–∑–∞—Ç–µ–ª–µ–π –∫–æ—Ñ–µ–π–Ω–∏</p>
  </div>
  <div class="stats-grid" id="dashStats"></div>
  <div style="display:grid;grid-template-columns:1fr 1fr;gap:24px">
    <div class="table-wrap">
      <div class="table-header"><h3>üî• –ü–æ—Å–ª–µ–¥–Ω–∏–µ –ø—Ä–æ–¥–∞–∂–∏</h3></div>
      <div class="table-scroll">
        <table><thead><tr><th>–¢–æ–≤–∞—Ä</th><th>–ö–æ–ª-–≤–æ</th><th>–°—É–º–º–∞</th><th>–î–∞—Ç–∞</th></tr></thead>
        <tbody id="dashSalesBody"></tbody></table>
      </div>
    </div>
    <div class="table-wrap">
      <div class="table-header"><h3>üöó –ê–∫—Ç–∏–≤–Ω—ã–µ –¥–æ—Å—Ç–∞–≤–∫–∏</h3></div>
      <div class="table-scroll">
        <table><thead><tr><th>ID</th><th>–ö–ª–∏–µ–Ω—Ç</th><th>–°—Ç–∞—Ç—É—Å</th><th>–°–æ—Ç—Ä—É–¥–Ω–∏–∫</th></tr></thead>
        <tbody id="dashDeliveryBody"></tbody></table>
      </div>
    </div>
  </div>
  <div class="table-wrap mt-24">
    <div class="table-header"><h3>‚ö†Ô∏è –¢–æ–≤–∞—Ä—ã —Å –Ω–∏–∑–∫–∏–º –æ—Å—Ç–∞—Ç–∫–æ–º (–º–µ–Ω–µ–µ 10)</h3></div>
    <div class="table-scroll">
      <table><thead><tr><th>–¢–æ–≤–∞—Ä</th><th>–ö–∞—Ç–µ–≥–æ—Ä–∏—è</th><th>–û—Å—Ç–∞—Ç–æ–∫</th><th>–¶–µ–Ω–∞</th></tr></thead>
      <tbody id="dashLowStockBody"></tbody></table>
    </div>
  </div>
</div>

<!-- ===== PRODUCTS ===== -->
<div class="page" id="page-products">
  <div class="page-header">
    <h1>üì¶ –¢–æ–≤–∞—Ä—ã –∏ –æ—Å—Ç–∞—Ç–∫–∏</h1>
    <p>–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞–º–∏, –æ—Å—Ç–∞—Ç–∫–∞–º–∏ –∏ –ø–æ—Å—Ç—É–ø–ª–µ–Ω–∏—è–º–∏</p>
    <div class="page-actions">
      <button class="btn btn-primary" onclick="openProductModal()">+ –î–æ–±–∞–≤–∏—Ç—å —Ç–æ–≤–∞—Ä</button>
      <button class="btn btn-success" onclick="openIncomingModal()">üì• –ü–æ—Å—Ç—É–ø–ª–µ–Ω–∏–µ</button>
      <button class="btn btn-outline" onclick="exportProducts()">üìã –≠–∫—Å–ø–æ—Ä—Ç</button>
    </div>
  </div>
  <div class="tabs">
    <button class="tab active" data-tab="products-list">–í—Å–µ —Ç–æ–≤–∞—Ä—ã</button>
    <button class="tab" data-tab="products-incoming">–ü–æ—Å—Ç—É–ø–ª–µ–Ω–∏—è</button>
  </div>
  <div class="tab-content active" id="tab-products-list">
    <div class="table-wrap">
      <div class="table-header">
        <h3>–¢–æ–≤–∞—Ä—ã (<span id="productsCount">0</span>)</h3>
        <div class="tools">
          <select id="prodCatFilter" class="search-input" style="width:150px"><option value="">–í—Å–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏</option><option>–ö–æ—Ñ–µ</option><option>–ß–∞–π</option><option>–î–µ—Å–µ—Ä—Ç—ã</option><option>–ó–∞–≤—Ç—Ä–∞–∫–∏</option><option>–ò–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç—ã</option><option>–£–ø–∞–∫–æ–≤–∫–∞</option></select>
          <input type="text" class="search-input" id="prodSearch" placeholder="üîç –ü–æ–∏—Å–∫ —Ç–æ–≤–∞—Ä–∞...">
        </div>
      </div>
      <div class="table-scroll">
        <table>
          <thead><tr><th>ID</th><th>–ù–∞–∑–≤–∞–Ω–∏–µ</th><th>–ö–∞—Ç–µ–≥–æ—Ä–∏—è</th><th>–¶–µ–Ω–∞</th><th>–û—Å—Ç–∞—Ç–æ–∫</th><th>–°—Ç–∞—Ç—É—Å</th><th>–î–µ–π—Å—Ç–≤–∏—è</th></tr></thead>
          <tbody id="productsBody"></tbody>
        </table>
      </div>
    </div>
  </div>
  <div class="tab-content" id="tab-products-incoming">
    <div class="table-wrap">
      <div class="table-header"><h3>–ò—Å—Ç–æ—Ä–∏—è –ø–æ—Å—Ç—É–ø–ª–µ–Ω–∏–π</h3></div>
      <div class="table-scroll">
        <table>
          <thead><tr><th>–î–∞—Ç–∞</th><th>–¢–æ–≤–∞—Ä</th><th>–ö–æ–ª-–≤–æ</th><th>–ü–æ—Å—Ç–∞–≤—â–∏–∫</th><th>–ü—Ä–∏–º–µ—á–∞–Ω–∏–µ</th></tr></thead>
          <tbody id="incomingBody"></tbody>
        </table>
      </div>
    </div>
  </div>
</div>

<!-- ===== SALES ===== -->
<div class="page" id="page-sales">
  <div class="page-header">
    <h1>üí∞ –ü—Ä–æ–¥–∞–∂–∏</h1>
    <p>–¢–∞–±–ª–∏—Ü–∞ –≤—Å–µ—Ö –ø—Ä–æ–¥–∞–∂ –∏ –∞–Ω–∞–ª–∏—Ç–∏–∫–∞</p>
    <div class="page-actions">
      <button class="btn btn-primary" onclick="openSaleModal()">+ –ù–æ–≤–∞—è –ø—Ä–æ–¥–∞–∂–∞</button>
      <button class="btn btn-outline" onclick="exportSales()">üìã –≠–∫—Å–ø–æ—Ä—Ç</button>
    </div>
  </div>
  <div class="stats-grid" id="salesStats"></div>
  <div class="table-wrap">
    <div class="table-header">
      <h3>–í—Å–µ –ø—Ä–æ–¥–∞–∂–∏ (<span id="salesCount">0</span>)</h3>
      <div class="tools">
        <input type="date" class="search-input" id="salesDateFrom" style="width:150px" title="–î–∞—Ç–∞ –æ—Ç">
        <input type="date" class="search-input" id="salesDateTo" style="width:150px" title="–î–∞—Ç–∞ –¥–æ">
        <input type="text" class="search-input" id="salesSearch" placeholder="üîç –ü–æ–∏—Å–∫...">
      </div>
    </div>
    <div class="table-scroll">
      <table>
        <thead><tr><th>ID</th><th>–î–∞—Ç–∞</th><th>–¢–æ–≤–∞—Ä</th><th>–ö–æ–ª-–≤–æ</th><th>–¶–µ–Ω–∞</th><th>–°—É–º–º–∞</th><th>–°–ø–æ—Å–æ–± –æ–ø–ª–∞—Ç—ã</th><th>–î–µ–π—Å—Ç–≤–∏—è</th></tr></thead>
        <tbody id="salesBody"></tbody>
      </table>
    </div>
  </div>
</div>

<!-- ===== DELIVERY ===== -->
<div class="page" id="page-delivery">
  <div class="page-header">
    <h1>üöó –î–æ—Å—Ç–∞–≤–∫–∞</h1>
    <p>–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∑–∞–∫–∞–∑–∞–º–∏ –Ω–∞ –¥–æ—Å—Ç–∞–≤–∫—É</p>
    <div class="page-actions">
      <button class="btn btn-primary" onclick="openDeliveryModal()">+ –ù–æ–≤–∞—è –¥–æ—Å—Ç–∞–≤–∫–∞</button>
      <button class="btn btn-outline" onclick="exportDeliveries()">üìã –≠–∫—Å–ø–æ—Ä—Ç</button>
    </div>
  </div>
  <div class="stats-grid" id="deliveryStats"></div>
  <div class="table-wrap">
    <div class="table-header">
      <h3>–í—Å–µ –¥–æ—Å—Ç–∞–≤–∫–∏ (<span id="deliveryCount">0</span>)</h3>
      <div class="tools">
        <select id="deliveryStatusFilter" class="search-input" style="width:160px">
          <option value="">–í—Å–µ —Å—Ç–∞—Ç—É—Å—ã</option>
          <option value="new">–ù–æ–≤—ã–π</option>
          <option value="assembling">–°–±–æ—Ä–∫–∞</option>
          <option value="shipping">–í –ø—É—Ç–∏</option>
          <option value="delivered">–î–æ—Å—Ç–∞–≤–ª–µ–Ω</option>
          <option value="cancelled">–û—Ç–º–µ–Ω—ë–Ω</option>
        </select>
        <input type="text" class="search-input" id="deliverySearch" placeholder="üîç –ü–æ–∏—Å–∫...">
      </div>
    </div>
    <div class="table-scroll">
      <table>
        <thead><tr><th>ID</th><th>–î–∞—Ç–∞</th><th>–ö–ª–∏–µ–Ω—Ç</th><th>–ê–¥—Ä–µ—Å</th><th>–°—É–º–º–∞</th><th>–°—Ç–∞—Ç—É—Å</th><th>–°–æ—Ç—Ä—É–¥–Ω–∏–∫ ID</th><th>–î–µ–π—Å—Ç–≤–∏—è</th></tr></thead>
        <tbody id="deliveryBody"></tbody>
      </table>
    </div>
  </div>
</div>

<!-- ===== SETTINGS ===== -->
<div class="page" id="page-settings">
  <div class="page-header">
    <h1>‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∏ AI —á–∞—Ç-–±–æ—Ç–∞</h1>
    <p>–ù–∞—Å—Ç—Ä–æ–π—Ç–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ AI –¥–ª—è —á–∞—Ç-–±–æ—Ç–∞ –Ω–∞ —Å–∞–π—Ç–µ</p>
  </div>
  <div class="config-panel">
    <h3>ü§ñ OpenRouter AI Configuration</h3>
    <div class="config-row">
      <label>AI –≤–∫–ª—é—á—ë–Ω:</label>
      <select id="cfgEnabled"><option value="false">–í—ã–∫–ª—é—á–µ–Ω</option><option value="true">–í–∫–ª—é—á—ë–Ω</option></select>
    </div>
    <div class="config-row">
      <label>API URL:</label>
      <input type="text" id="cfgUrl" value="https://openrouter.ai/api/v1/chat/completions">
    </div>
    <div class="config-row">
      <label>–ú–æ–¥–µ–ª—å:</label>
      <input type="text" id="cfgModel" value="z-ai/glm-4.5-air:free">
    </div>
    <div class="config-row">
      <label>API Key:</label>
      <input type="password" id="cfgKey" placeholder="sk-or-v1-...">
    </div>
    <div class="config-row">
      <label>Max Tokens:</label>
      <input type="number" id="cfgTokens" value="300" min="50" max="2000">
    </div>
    <div style="margin-top:16px;display:flex;gap:12px">
      <button class="btn btn-primary" onclick="saveAIConfig()">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
      <button class="btn btn-outline" onclick="testAI()">üß™ –¢–µ—Å—Ç AI</button>
    </div>
    <div id="aiTestResult" style="margin-top:16px;padding:12px;border-radius:8px;background:#fafaf9;font-size:13px;display:none"></div>
  </div>
  <div class="config-panel">
    <h3>üóÑÔ∏è –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã–º–∏</h3>
    <p style="font-size:13px;color:#888;margin-bottom:16px">–í—Å–µ –¥–∞–Ω–Ω—ã–µ —Ö—Ä–∞–Ω—è—Ç—Å—è –≤ localStorage –≤–∞—à–µ–≥–æ –±—Ä–∞—É–∑–µ—Ä–∞.</p>
    <div style="display:flex;gap:12px;flex-wrap:wrap">
      <button class="btn btn-outline" onclick="exportAllData()">üì• –≠–∫—Å–ø–æ—Ä—Ç –≤—Å–µ—Ö –¥–∞–Ω–Ω—ã—Ö (JSON)</button>
      <button class="btn btn-outline" onclick="document.getElementById('importFile').click()">üì§ –ò–º–ø–æ—Ä—Ç –¥–∞–Ω–Ω—ã—Ö</button>
      <input type="file" id="importFile" accept=".json" style="display:none" onchange="importAllData(event)">
      <button class="btn btn-danger" onclick="clearAllData()">üóëÔ∏è –û—á–∏—Å—Ç–∏—Ç—å –≤—Å–µ –¥–∞–Ω–Ω—ã–µ</button>
    </div>
  </div>
  <div class="config-panel">
    <h3>‚ÑπÔ∏è –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è</h3>
    <p style="font-size:13px;color:#888;line-height:2">
      üìå –î–∞–Ω–Ω—ã–µ —Ö—Ä–∞–Ω—è—Ç—Å—è –≤ localStorage ‚Äî –æ–Ω–∏ –ø—Ä–∏–≤—è–∑–∞–Ω—ã –∫ —ç—Ç–æ–º—É –±—Ä–∞—É–∑–µ—Ä—É<br>
      üìå –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –≠–∫—Å–ø–æ—Ä—Ç/–ò–º–ø–æ—Ä—Ç –¥–ª—è –ø–µ—Ä–µ–Ω–æ—Å–∞ –¥–∞–Ω–Ω—ã—Ö –º–µ–∂–¥—É —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞–º–∏<br>
      üìå –î–ª—è —Ä–∞–±–æ—Ç—ã AI –Ω—É–∂–µ–Ω API –∫–ª—é—á –æ—Ç <a href="https://openrouter.ai" target="_blank" style="color:#92400e;text-decoration:underline">OpenRouter</a><br>
      üìå <strong>–í—Å–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è (—Ç–æ–≤–∞—Ä—ã, —Ü–µ–Ω—ã, –æ—Å—Ç–∞—Ç–∫–∏) –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ—Ç–æ–±—Ä–∞–∂–∞—é—Ç—Å—è –Ω–∞ –æ—Å–Ω–æ–≤–Ω–æ–º —Å–∞–π—Ç–µ</strong><br>
      üìå –ù–∞—Å—Ç—Ä–æ–π–∫–∏ AI –∏–∑ –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª–∏ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–æ–¥—Ö–≤–∞—Ç—ã–≤–∞—é—Ç—Å—è —á–∞—Ç-–±–æ—Ç–æ–º –Ω–∞ —Å–∞–π—Ç–µ<br>
      üìå –ï—Å–ª–∏ –æ—Ç–∫—Ä—ã—Ç—ã –æ–±–µ –≤–∫–ª–∞–¥–∫–∏ ‚Äî –∏–∑–º–µ–Ω–µ–Ω–∏—è –ø—Ä–∏–º–µ–Ω—è—é—Ç—Å—è –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏
    </p>
  </div>
</div>

</main>
</div>

<!-- ==================== MODALS ==================== -->

<!-- Product Modal -->
<div class="modal-overlay" id="productModal">
  <div class="modal">
    <div class="modal-head">
      <h3 id="productModalTitle">–î–æ–±–∞–≤–∏—Ç—å —Ç–æ–≤–∞—Ä</h3>
      <button class="modal-close" onclick="closeModal('productModal')">‚úï</button>
    </div>
    <div class="modal-body">
      <input type="hidden" id="prodEditId">
      <div class="form-row">
        <div class="form-group">
          <label>–ù–∞–∑–≤–∞–Ω–∏–µ *</label>
          <input type="text" id="prodName" placeholder="–ö–∞–ø—É—á–∏–Ω–æ">
        </div>
        <div class="form-group">
          <label>–ö–∞—Ç–µ–≥–æ—Ä–∏—è *</label>
          <select id="prodCat">
            <option>–ö–æ—Ñ–µ</option><option>–ß–∞–π</option><option>–î–µ—Å–µ—Ä—Ç—ã</option><option>–ó–∞–≤—Ç—Ä–∞–∫–∏</option><option>–ò–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç—ã</option><option>–£–ø–∞–∫–æ–≤–∫–∞</option>
          </select>
        </div>
      </div>
      <div class="form-row">
        <div class="form-group">
          <label>–¶–µ–Ω–∞ (‚ÇΩ) *</label>
          <input type="number" id="prodPrice" placeholder="250" min="0">
        </div>
        <div class="form-group">
          <label>–û—Å—Ç–∞—Ç–æ–∫ (—à—Ç)</label>
          <input type="number" id="prodStock" placeholder="100" min="0">
        </div>
      </div>
      <div class="form-group">
        <label>–û–ø–∏—Å–∞–Ω–∏–µ</label>
        <textarea id="prodDesc" rows="2" placeholder="–ö—Ä–∞—Ç–∫–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞..."></textarea>
      </div>
      <div class="form-group">
        <label>–≠–º–æ–¥–∑–∏</label>
        <input type="text" id="prodEmoji" placeholder="‚òï" maxlength="4">
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-outline" onclick="closeModal('productModal')">–û—Ç–º–µ–Ω–∞</button>
      <button class="btn btn-primary" onclick="saveProduct()">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
    </div>
  </div>
</div>

<!-- Incoming Modal -->
<div class="modal-overlay" id="incomingModal">
  <div class="modal">
    <div class="modal-head">
      <h3>üì• –ü–æ—Å—Ç—É–ø–ª–µ–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞</h3>
      <button class="modal-close" onclick="closeModal('incomingModal')">‚úï</button>
    </div>
    <div class="modal-body">
      <div class="form-group">
        <label>–¢–æ–≤–∞—Ä *</label>
        <select id="incProduct"></select>
      </div>
      <div class="form-row">
        <div class="form-group">
          <label>–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ *</label>
          <input type="number" id="incQty" placeholder="50" min="1">
        </div>
        <div class="form-group">
          <label>–î–∞—Ç–∞</label>
          <input type="date" id="incDate">
        </div>
      </div>
      <div class="form-group">
        <label>–ü–æ—Å—Ç–∞–≤—â–∏–∫</label>
        <input type="text" id="incSupplier" placeholder="–û–û–û –ö–æ—Ñ–µ—Ç—Ä–µ–π–¥">
      </div>
      <div class="form-group">
        <label>–ü—Ä–∏–º–µ—á–∞–Ω–∏–µ</label>
        <textarea id="incNote" rows="2" placeholder="–î–æ–ø. –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è..."></textarea>
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-outline" onclick="closeModal('incomingModal')">–û—Ç–º–µ–Ω–∞</button>
      <button class="btn btn-success" onclick="saveIncoming()">üì• –ü—Ä–∏–Ω—è—Ç—å</button>
    </div>
  </div>
</div>

<!-- Sale Modal -->
<div class="modal-overlay" id="saleModal">
  <div class="modal">
    <div class="modal-head">
      <h3>üí∞ –ù–æ–≤–∞—è –ø—Ä–æ–¥–∞–∂–∞</h3>
      <button class="modal-close" onclick="closeModal('saleModal')">‚úï</button>
    </div>
    <div class="modal-body">
      <div class="form-group">
        <label>–¢–æ–≤–∞—Ä *</label>
        <select id="saleProduct" onchange="updateSalePrice()"></select>
      </div>
      <div class="form-row">
        <div class="form-group">
          <label>–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ *</label>
          <input type="number" id="saleQty" value="1" min="1" onchange="updateSaleTotal()" oninput="updateSaleTotal()">
        </div>
        <div class="form-group">
          <label>–¶–µ–Ω–∞ –∑–∞ –µ–¥. (‚ÇΩ)</label>
          <input type="number" id="salePrice" min="0">
        </div>
      </div>
      <div class="form-row">
        <div class="form-group">
          <label>–°–ø–æ—Å–æ–± –æ–ø–ª–∞—Ç—ã</label>
          <select id="salePayment">
            <option>–ù–∞–ª–∏—á–Ω—ã–µ</option><option>–ö–∞—Ä—Ç–∞</option><option>Apple/Google Pay</option><option>–°–ë–ü</option><option>–°–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç</option>
          </select>
        </div>
        <div class="form-group">
          <label>–î–∞—Ç–∞</label>
          <input type="date" id="saleDate">
        </div>
      </div>
      <div class="form-group">
        <label>–ò—Ç–æ–≥–æ</label>
        <div id="saleTotalDisplay" style="font-size:24px;font-weight:800;color:#92400e">0 ‚ÇΩ</div>
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-outline" onclick="closeModal('saleModal')">–û—Ç–º–µ–Ω–∞</button>
      <button class="btn btn-primary" onclick="saveSale()">üí∞ –û—Ñ–æ—Ä–º–∏—Ç—å</button>
    </div>
  </div>
</div>

<!-- Delivery Modal -->
<div class="modal-overlay" id="deliveryModal">
  <div class="modal">
    <div class="modal-head">
      <h3 id="deliveryModalTitle">üöó –ù–æ–≤–∞—è –¥–æ—Å—Ç–∞–≤–∫–∞</h3>
      <button class="modal-close" onclick="closeModal('deliveryModal')">‚úï</button>
    </div>
    <div class="modal-body">
      <input type="hidden" id="delEditId">
      <div class="form-row">
        <div class="form-group">
          <label>–ö–ª–∏–µ–Ω—Ç *</label>
          <input type="text" id="delClient" placeholder="–ò–≤–∞–Ω –ü–µ—Ç—Ä–æ–≤">
        </div>
        <div class="form-group">
          <label>–¢–µ–ª–µ—Ñ–æ–Ω *</label>
          <input type="tel" id="delPhone" placeholder="+7 (999) 123-45-67">
        </div>
      </div>
      <div class="form-group">
        <label>–ê–¥—Ä–µ—Å –¥–æ—Å—Ç–∞–≤–∫–∏ *</label>
        <input type="text" id="delAddress" placeholder="—É–ª. –ü—É—à–∫–∏–Ω–∞, –¥.10, –∫–≤.5">
      </div>
      <div class="form-group">
        <label>–¢–æ–≤–∞—Ä—ã (—á–µ—Ä–µ–∑ –∑–∞–ø—è—Ç—É—é) *</label>
        <input type="text" id="delItems" placeholder="–ö–∞–ø—É—á–∏–Ω–æ x2, –ß–∏–∑–∫–µ–π–∫ x1">
      </div>
      <div class="form-row">
        <div class="form-group">
          <label>–°—É–º–º–∞ (‚ÇΩ) *</label>
          <input type="number" id="delSum" placeholder="850" min="0">
        </div>
        <div class="form-group">
          <label>ID —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞</label>
          <input type="text" id="delEmployee" placeholder="EMP-001">
        </div>
      </div>
      <div class="form-row">
        <div class="form-group">
          <label>–°—Ç–∞—Ç—É—Å</label>
          <select id="delStatus">
            <option value="new">üÜï –ù–æ–≤—ã–π</option>
            <option value="assembling">üì¶ –°–±–æ—Ä–∫–∞</option>
            <option value="shipping">üöó –í –ø—É—Ç–∏</option>
            <option value="delivered">‚úÖ –î–æ—Å—Ç–∞–≤–ª–µ–Ω</option>
            <option value="cancelled">‚ùå –û—Ç–º–µ–Ω—ë–Ω</option>
          </select>
        </div>
        <div class="form-group">
          <label>–î–∞—Ç–∞</label>
          <input type="date" id="delDate">
        </div>
      </div>
      <div class="form-group">
        <label>–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π</label>
        <textarea id="delComment" rows="2" placeholder="–ü–æ–∑–≤–æ–Ω–∏—Ç—å –∑–∞ 15 –º–∏–Ω..."></textarea>
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-outline" onclick="closeModal('deliveryModal')">–û—Ç–º–µ–Ω–∞</button>
      <button class="btn btn-primary" onclick="saveDelivery()">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
    </div>
  </div>
</div>


<script>
/* ================================================================
   DATA LAYER ‚Äî localStorage
   ================================================================ */
function getData(key, fallback) {
  try { var d = localStorage.getItem('bb_' + key); return d ? JSON.parse(d) : fallback; }
  catch(e) { return fallback; }
}
function setData(key, val) {
  localStorage.setItem('bb_' + key, JSON.stringify(val));
}
function genId() { return 'ID-' + Date.now().toString(36).toUpperCase() + Math.random().toString(36).substr(2,4).toUpperCase(); }
function today() { return new Date().toISOString().split('T')[0]; }
function formatDate(d) {
  if (!d) return '‚Äî';
  var parts = d.split('-');
  return parts[2] + '.' + parts[1] + '.' + parts[0];
}
function formatMoney(n) { return Number(n).toLocaleString('ru-RU') + ' ‚ÇΩ'; }

// Initialize with demo data if empty ‚Äî –∏—Å–ø–æ–ª—å–∑—É–µ—Ç —Ç–µ –∂–µ –¥–∞–Ω–Ω—ã–µ, —á—Ç–æ –∏ –æ—Å–Ω–æ–≤–Ω–æ–π —Å–∞–π—Ç
function initDemoData() {
  // –ï—Å–ª–∏ —Ç–æ–≤–∞—Ä—ã —É–∂–µ –µ—Å—Ç—å (—Å–æ–∑–¥–∞–Ω—ã –æ—Å–Ω–æ–≤–Ω—ã–º —Å–∞–π—Ç–æ–º) ‚Äî –Ω–µ –ø–µ—Ä–µ–∑–∞–ø–∏—Å—ã–≤–∞–µ–º
  var existingProducts = getData('products', null);
  
  if (!existingProducts || existingProducts.length === 0) {
    // –°–æ–∑–¥–∞—ë–º —Ç–æ–≤–∞—Ä—ã –¥–ª—è –≤–∏—Ç—Ä–∏–Ω—ã + –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏–µ —Ç–æ–≤–∞—Ä—ã
    var products = [
      { id:genId(), name:'–≠—Å–ø—Ä–µ—Å—Å–æ', cat:'–ö–æ—Ñ–µ', price:150, stock:120, desc:'–ö–ª–∞—Å—Å–∏—á–µ—Å–∫–∏–π –∫—Ä–µ–ø–∫–∏–π –∫–æ—Ñ–µ', emoji:'‚òï', hit:false },
      { id:genId(), name:'–ö–∞–ø—É—á–∏–Ω–æ', cat:'–ö–æ—Ñ–µ', price:250, stock:85, desc:'–≠—Å–ø—Ä–µ—Å—Å–æ —Å –Ω–µ–∂–Ω–æ–π –º–æ–ª–æ—á–Ω–æ–π –ø–µ–Ω–∫–æ–π', emoji:'ü•õ', hit:true },
      { id:genId(), name:'–õ–∞—Ç—Ç–µ', cat:'–ö–æ—Ñ–µ', price:280, stock:72, desc:'–ú—è–≥–∫–∏–π –∫–æ—Ñ–µ —Å –±–æ–ª—å—à–∏–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ–º –º–æ–ª–æ–∫–∞', emoji:'üç¶', hit:true },
      { id:genId(), name:'–§–ª—ç—Ç –£–∞–π—Ç', cat:'–ö–æ—Ñ–µ', price:290, stock:52, desc:'–î–≤–æ–π–Ω–æ–π —ç—Å–ø—Ä–µ—Å—Å–æ —Å –±–∞—Ä—Ö–∞—Ç–Ω—ã–º –º–æ–ª–æ–∫–æ–º', emoji:'‚ú®', hit:false },
      { id:genId(), name:'–ú–æ–∫–∫–æ', cat:'–ö–æ—Ñ–µ', price:300, stock:38, desc:'–ö–æ—Ñ–µ —Å —à–æ–∫–æ–ª–∞–¥–æ–º –∏ –≤–∑–±–∏—Ç—ã–º–∏ —Å–ª–∏–≤–∫–∞–º–∏', emoji:'üç´', hit:false },
      { id:genId(), name:'–†–∞—Ñ –∫–æ—Ñ–µ', cat:'–ö–æ—Ñ–µ', price:320, stock:45, desc:'–ö–æ—Ñ–µ —Å–æ —Å–ª–∏–≤–∫–∞–º–∏ –∏ –≤–∞–Ω–∏–ª—å–Ω—ã–º —Å–∞—Ö–∞—Ä–æ–º', emoji:'üßÅ', hit:true },
      { id:genId(), name:'–ê–π—Å-–∫–æ—Ñ–µ', cat:'–ö–æ—Ñ–µ', price:270, stock:60, desc:'–•–æ–ª–æ–¥–Ω—ã–π –∫–æ—Ñ–µ —Å–æ –ª—å–¥–æ–º', emoji:'üßä', hit:false },
      { id:genId(), name:'–ó–µ–ª—ë–Ω—ã–π —á–∞–π', cat:'–ß–∞–π', price:180, stock:90, desc:'–û—Ç–±–æ—Ä–Ω—ã–π —è–ø–æ–Ω—Å–∫–∏–π —Å–µ–Ω—á–∞', emoji:'üçµ', hit:false },
      { id:genId(), name:'–ò–≤–∞–Ω-—á–∞–π', cat:'–ß–∞–π', price:200, stock:55, desc:'–§–µ—Ä–º–µ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —Å —è–≥–æ–¥–∞–º–∏', emoji:'üåø', hit:false },
      { id:genId(), name:'–ú–∞—Ç—á–∞-–ª–∞—Ç—Ç–µ', cat:'–ß–∞–π', price:300, stock:35, desc:'–Ø–ø–æ–Ω—Å–∫–∏–π —á–∞–π –º–∞—Ç—á–∞ —Å –º–æ–ª–æ–∫–æ–º', emoji:'üçÉ', hit:true },
      { id:genId(), name:'–ß–∏–∑–∫–µ–π–∫', cat:'–î–µ—Å–µ—Ä—Ç—ã', price:350, stock:18, desc:'–ù—å—é-–ô–æ—Ä–∫—Å–∫–∏–π —Å–æ —Å–ª–∏–≤–æ—á–Ω—ã–º –∫—Ä–µ–º–æ–º', emoji:'üç∞', hit:true },
      { id:genId(), name:'–¢–∏—Ä–∞–º–∏—Å—É', cat:'–î–µ—Å–µ—Ä—Ç—ã', price:380, stock:12, desc:'–ö–ª–∞—Å—Å–∏—á–µ—Å–∫–∏–π –∏—Ç–∞–ª—å—è–Ω—Å–∫–∏–π –¥–µ—Å–µ—Ä—Ç', emoji:'üçÆ', hit:false },
      { id:genId(), name:'–ö—Ä—É–∞—Å—Å–∞–Ω', cat:'–î–µ—Å–µ—Ä—Ç—ã', price:200, stock:30, desc:'–ú–∞—Å–ª—è–Ω–∏—Å—Ç—ã–π, –≤–æ–∑–¥—É—à–Ω—ã–π, —Ö—Ä—É—Å—Ç—è—â–∏–π', emoji:'ü•ê', hit:false },
      { id:genId(), name:'–ú–∞—Ñ—Ñ–∏–Ω', cat:'–î–µ—Å–µ—Ä—Ç—ã', price:220, stock:25, desc:'–®–æ–∫–æ–ª–∞–¥–Ω—ã–π —Å –∂–∏–¥–∫–æ–π –Ω–∞—á–∏–Ω–∫–æ–π', emoji:'üßÅ', hit:false },
      { id:genId(), name:'–ê–≤–æ–∫–∞–¥–æ-—Ç–æ—Å—Ç', cat:'–ó–∞–≤—Ç—Ä–∞–∫–∏', price:420, stock:8, desc:'–° —è–π—Ü–æ–º –ø–∞—à–æ—Ç –∏ –º–∏–∫—Ä–æ–∑–µ–ª–µ–Ω—å—é', emoji:'ü•ë', hit:true },
      { id:genId(), name:'–°—ã—Ä–Ω–∏–∫–∏', cat:'–ó–∞–≤—Ç—Ä–∞–∫–∏', price:350, stock:15, desc:'–°–æ —Å–º–µ—Ç–∞–Ω–æ–π –∏ —è–≥–æ–¥–Ω—ã–º —Å–æ—É—Å–æ–º', emoji:'ü•û', hit:false },
      { id:genId(), name:'–ë–æ—É–ª —Å –∞—Å–∞–∏', cat:'–ó–∞–≤—Ç—Ä–∞–∫–∏', price:450, stock:20, desc:'–ì—Ä–∞–Ω–æ–ª–∞, —Ñ—Ä—É–∫—Ç—ã –∏ –º—ë–¥', emoji:'ü´ê', hit:false },
      { id:genId(), name:'–Ø–π—Ü–∞ –ë–µ–Ω–µ–¥–∏–∫—Ç', cat:'–ó–∞–≤—Ç—Ä–∞–∫–∏', price:480, stock:10, desc:'–° –≥–æ–ª–ª–∞–Ω–¥—Å–∫–∏–º —Å–æ—É—Å–æ–º –Ω–∞ –±—Ä–∏–æ—à–∏', emoji:'üç≥', hit:false },
      { id:genId(), name:'–ú–æ–ª–æ–∫–æ 3.2%', cat:'–ò–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç—ã', price:80, stock:200, desc:'–õ–∏—Ç—Ä–æ–≤–∞—è —É–ø–∞–∫–æ–≤–∫–∞', emoji:'ü•õ', hit:false },
      { id:genId(), name:'–û–≤—Å—è–Ω–æ–µ –º–æ–ª–æ–∫–æ', cat:'–ò–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç—ã', price:180, stock:50, desc:'–†–∞—Å—Ç–∏—Ç–µ–ª—å–Ω–æ–µ', emoji:'üåæ', hit:false },
      { id:genId(), name:'–ö–æ—Ñ–µ –∑—ë—Ä–Ω–∞ 1–∫–≥', cat:'–ò–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç—ã', price:1200, stock:5, desc:'–ê—Ä–∞–±–∏–∫–∞ –≠—Ñ–∏–æ–ø–∏—è', emoji:'‚òï', hit:false },
      { id:genId(), name:'–°—Ç–∞–∫–∞–Ω 300–º–ª', cat:'–£–ø–∞–∫–æ–≤–∫–∞', price:8, stock:500, desc:'–ë—É–º–∞–∂–Ω—ã–π', emoji:'ü•§', hit:false },
    ];
    setData('products', products);
  }

  // –ü—Ä–æ–¥–∞–∂–∏ ‚Äî —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –ø—É—Å—Ç—ã–µ
  if (!getData('sales', null) || getData('sales', []).length === 0) {
    var prods = getData('products', []);
    var sales = [];
    var daysAgo = [0,0,0,1,1,2,2,3,4,5,6,7,8,9,10];
    for (var i = 0; i < 15; i++) {
      var p = prods[Math.floor(Math.random() * Math.min(10, prods.length))];
      if (!p) continue;
      var qty = Math.floor(Math.random() * 4) + 1;
      var d = new Date(); d.setDate(d.getDate() - daysAgo[i]);
      sales.push({
        id: genId(),
        product: p.name,
        qty: qty,
        price: p.price,
        total: p.price * qty,
        payment: ['–ù–∞–ª–∏—á–Ω—ã–µ','–ö–∞—Ä—Ç–∞','Apple/Google Pay','–°–ë–ü'][Math.floor(Math.random()*4)],
        date: d.toISOString().split('T')[0]
      });
    }
    setData('sales', sales);
  }

  // –î–æ—Å—Ç–∞–≤–∫–∏ ‚Äî —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –ø—É—Å—Ç—ã–µ
  if (!getData('deliveries', null) || getData('deliveries', []).length === 0) {
    var deliveries = [
      { id:genId(), date:today(), client:'–ê–Ω–Ω–∞ –°–º–∏—Ä–Ω–æ–≤–∞', phone:'+7 (999) 111-22-33', address:'—É–ª. –õ–µ–Ω–∏–Ω–∞, 15, –∫–≤.8', items:'–ö–∞–ø—É—á–∏–Ω–æ x2, –ß–∏–∑–∫–µ–π–∫ x1', sum:850, status:'shipping', employee:'EMP-003', comment:'' },
      { id:genId(), date:today(), client:'–î–º–∏—Ç—Ä–∏–π –ö–æ–∑–ª–æ–≤', phone:'+7 (999) 444-55-66', address:'–ø—Ä. –ú–∏—Ä–∞, 42, –æ—Ñ.12', items:'–õ–∞—Ç—Ç–µ x3, –ö—Ä—É–∞—Å—Å–∞–Ω x3', sum:1440, status:'assembling', employee:'EMP-001', comment:'–ü–æ–∑–≤–æ–Ω–∏—Ç—å –∑–∞—Ä–∞–Ω–µ–µ' },
      { id:genId(), date:today(), client:'–ï–ª–µ–Ω–∞ –ü–æ–ø–æ–≤–∞', phone:'+7 (999) 777-88-99', address:'—É–ª. –ì–∞–≥–∞—Ä–∏–Ω–∞, 7', items:'–†–∞—Ñ x1, –¢–∏—Ä–∞–º–∏—Å—É x1', sum:700, status:'new', employee:'', comment:'' },
    ];
    setData('deliveries', deliveries);
  }

  // –ü–æ—Å—Ç—É–ø–ª–µ–Ω–∏—è ‚Äî —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –ø—É—Å—Ç—ã–µ
  if (!getData('incoming', null) || getData('incoming', []).length === 0) {
    setData('incoming', [
      { id:genId(), date:today(), product:'–ö–æ—Ñ–µ –∑—ë—Ä–Ω–∞ 1–∫–≥', qty:10, supplier:'–ö–æ—Ñ–µ–¢—Ä–µ–π–¥', note:'–ê—Ä–∞–±–∏–∫–∞ –≠—Ñ–∏–æ–ø–∏—è, –Ω–æ–≤–∞—è –ø–∞—Ä—Ç–∏—è' },
      { id:genId(), date:today(), product:'–ú–æ–ª–æ–∫–æ 3.2%', qty:50, supplier:'–ú–æ–ª–æ–∫–æ–û–ø—Ç', note:'' },
    ]);
  }
}

initDemoData();

/* ================================================================
   NAVIGATION
   ================================================================ */
var currentPage = 'dashboard';

document.querySelectorAll('.nav-item').forEach(function(item) {
  item.addEventListener('click', function() {
    var page = this.getAttribute('data-page');
    navigateTo(page);
    // Close mobile sidebar
    document.getElementById('sidebar').classList.remove('open');
    document.getElementById('sidebarOverlay').classList.remove('show');
  });
});

function navigateTo(page) {
  currentPage = page;
  document.querySelectorAll('.nav-item').forEach(function(n) { n.classList.remove('active'); });
  document.querySelectorAll('.page').forEach(function(p) { p.classList.remove('active'); });
  document.querySelector('.nav-item[data-page="'+page+'"]').classList.add('active');
  document.getElementById('page-'+page).classList.add('active');
  refreshPage(page);
}

// Tabs
document.querySelectorAll('.tab').forEach(function(tab) {
  tab.addEventListener('click', function() {
    var tabId = this.getAttribute('data-tab');
    var parent = this.closest('.page');
    parent.querySelectorAll('.tab').forEach(function(t) { t.classList.remove('active'); });
    parent.querySelectorAll('.tab-content').forEach(function(c) { c.classList.remove('active'); });
    this.classList.add('active');
    document.getElementById('tab-'+tabId).classList.add('active');
  });
});

// Mobile sidebar
document.getElementById('burgerBtn').addEventListener('click', function() {
  document.getElementById('sidebar').classList.add('open');
  document.getElementById('sidebarOverlay').classList.add('show');
});
document.getElementById('sidebarOverlay').addEventListener('click', function() {
  document.getElementById('sidebar').classList.remove('open');
  this.classList.remove('show');
});

/* ================================================================
   TOAST
   ================================================================ */
function showToast(msg, type) {
  var toast = document.getElementById('toast');
  toast.textContent = msg;
  toast.className = 'toast ' + (type || 'success');
  toast.classList.add('show');
  setTimeout(function() { toast.classList.remove('show'); }, 3000);
}

/* ================================================================
   MODAL
   ================================================================ */
function openModal(id) { document.getElementById(id).classList.add('open'); }
function closeModal(id) { document.getElementById(id).classList.remove('open'); }

// Close modals on overlay click
document.querySelectorAll('.modal-overlay').forEach(function(overlay) {
  overlay.addEventListener('click', function(e) {
    if (e.target === this) this.classList.remove('open');
  });
});

/* ================================================================
   PRODUCTS
   ================================================================ */
function getProducts() { return getData('products', []); }
function setProducts(arr) { setData('products', arr); }

function renderProducts() {
  var products = getProducts();
  var search = document.getElementById('prodSearch').value.toLowerCase();
  var catFilter = document.getElementById('prodCatFilter').value;
  var filtered = products.filter(function(p) {
    if (catFilter && p.cat !== catFilter) return false;
    if (search && p.name.toLowerCase().indexOf(search) === -1 && p.cat.toLowerCase().indexOf(search) === -1) return false;
    return true;
  });

  document.getElementById('productsCount').textContent = filtered.length;
  var tbody = document.getElementById('productsBody');
  if (filtered.length === 0) {
    tbody.innerHTML = '<tr><td colspan="7" class="table-empty">–ù–µ—Ç —Ç–æ–≤–∞—Ä–æ–≤</td></tr>';
    return;
  }
  tbody.innerHTML = filtered.map(function(p) {
    var stockStatus = p.stock <= 0 ? '<span class="status red">–ù–µ—Ç</span>'
      : p.stock < 10 ? '<span class="status yellow">–ú–∞–ª–æ (' + p.stock + ')</span>'
      : '<span class="status green">–í –Ω–∞–ª–∏—á–∏–∏</span>';
    return '<tr>' +
      '<td class="text-muted" style="font-size:11px">' + p.id + '</td>' +
      '<td><strong>' + (p.emoji||'') + ' ' + p.name + '</strong>' + (p.desc ? '<br><span class="text-muted" style="font-size:11px">' + p.desc + '</span>' : '') + '</td>' +
      '<td>' + p.cat + '</td>' +
      '<td class="text-bold">' + formatMoney(p.price) + '</td>' +
      '<td>' + p.stock + ' —à—Ç</td>' +
      '<td>' + stockStatus + '</td>' +
      '<td class="actions-cell">' +
        '<button class="btn-icon" onclick="editProduct(\'' + p.id + '\')" title="–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å">‚úèÔ∏è</button>' +
        '<button class="btn-icon danger" onclick="deleteProduct(\'' + p.id + '\')" title="–£–¥–∞–ª–∏—Ç—å">üóëÔ∏è</button>' +
      '</td></tr>';
  }).join('');
}

document.getElementById('prodSearch').addEventListener('input', renderProducts);
document.getElementById('prodCatFilter').addEventListener('change', renderProducts);

function openProductModal(id) {
  document.getElementById('prodEditId').value = '';
  document.getElementById('prodName').value = '';
  document.getElementById('prodCat').value = '–ö–æ—Ñ–µ';
  document.getElementById('prodPrice').value = '';
  document.getElementById('prodStock').value = '';
  document.getElementById('prodDesc').value = '';
  document.getElementById('prodEmoji').value = '';
  document.getElementById('productModalTitle').textContent = '–î–æ–±–∞–≤–∏—Ç—å —Ç–æ–≤–∞—Ä';
  openModal('productModal');
}

function editProduct(id) {
  var p = getProducts().find(function(x) { return x.id === id; });
  if (!p) return;
  document.getElementById('prodEditId').value = p.id;
  document.getElementById('prodName').value = p.name;
  document.getElementById('prodCat').value = p.cat;
  document.getElementById('prodPrice').value = p.price;
  document.getElementById('prodStock').value = p.stock;
  document.getElementById('prodDesc').value = p.desc || '';
  document.getElementById('prodEmoji').value = p.emoji || '';
  document.getElementById('productModalTitle').textContent = '–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å: ' + p.name;
  openModal('productModal');
}

function saveProduct() {
  var name = document.getElementById('prodName').value.trim();
  var cat = document.getElementById('prodCat').value;
  var price = Number(document.getElementById('prodPrice').value);
  var stock = Number(document.getElementById('prodStock').value) || 0;
  var desc = document.getElementById('prodDesc').value.trim();
  var emoji = document.getElementById('prodEmoji').value.trim();
  var editId = document.getElementById('prodEditId').value;

  if (!name || !price) { showToast('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –∏ —Ü–µ–Ω—É', 'error'); return; }

  var products = getProducts();
  if (editId) {
    products = products.map(function(p) {
      if (p.id === editId) return { id:p.id, name:name, cat:cat, price:price, stock:stock, desc:desc, emoji:emoji };
      return p;
    });
    showToast('‚úÖ –¢–æ–≤–∞—Ä –æ–±–Ω–æ–≤–ª—ë–Ω');
  } else {
    products.push({ id:genId(), name:name, cat:cat, price:price, stock:stock, desc:desc, emoji:emoji });
    showToast('‚úÖ –¢–æ–≤–∞—Ä –¥–æ–±–∞–≤–ª–µ–Ω');
  }
  setProducts(products);
  closeModal('productModal');
  renderProducts();
}

function deleteProduct(id) {
  if (!confirm('–£–¥–∞–ª–∏—Ç—å —ç—Ç–æ—Ç —Ç–æ–≤–∞—Ä?')) return;
  setProducts(getProducts().filter(function(p) { return p.id !== id; }));
  showToast('üóëÔ∏è –¢–æ–≤–∞—Ä —É–¥–∞–ª—ë–Ω');
  renderProducts();
}

function exportProducts() {
  downloadJSON('products_' + today() + '.json', getProducts());
  showToast('üìã –¢–æ–≤–∞—Ä—ã —ç–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω—ã');
}

/* ================================================================
   INCOMING (–ü–æ—Å—Ç—É–ø–ª–µ–Ω–∏—è)
   ================================================================ */
function getIncoming() { return getData('incoming', []); }
function setIncoming(arr) { setData('incoming', arr); }

function renderIncoming() {
  var list = getIncoming();
  var tbody = document.getElementById('incomingBody');
  if (list.length === 0) {
    tbody.innerHTML = '<tr><td colspan="5" class="table-empty">–ù–µ—Ç –ø–æ—Å—Ç—É–ø–ª–µ–Ω–∏–π</td></tr>';
    return;
  }
  tbody.innerHTML = list.map(function(inc) {
    return '<tr>' +
      '<td>' + formatDate(inc.date) + '</td>' +
      '<td><strong>' + inc.product + '</strong></td>' +
      '<td class="text-bold">+' + inc.qty + ' —à—Ç</td>' +
      '<td>' + (inc.supplier || '‚Äî') + '</td>' +
      '<td class="text-muted">' + (inc.note || '‚Äî') + '</td>' +
    '</tr>';
  }).join('');
}

function openIncomingModal() {
  var products = getProducts();
  var sel = document.getElementById('incProduct');
  sel.innerHTML = products.map(function(p) {
    return '<option>' + (p.emoji||'') + ' ' + p.name + '</option>';
  }).join('');
  document.getElementById('incQty').value = '';
  document.getElementById('incDate').value = today();
  document.getElementById('incSupplier').value = '';
  document.getElementById('incNote').value = '';
  openModal('incomingModal');
}

function saveIncoming() {
  var productName = document.getElementById('incProduct').value.replace(/^[^\s]+ /, '');
  var rawVal = document.getElementById('incProduct').value;
  var qty = Number(document.getElementById('incQty').value);
  var date = document.getElementById('incDate').value || today();
  var supplier = document.getElementById('incSupplier').value.trim();
  var note = document.getElementById('incNote').value.trim();

  if (!qty || qty <= 0) { showToast('–£–∫–∞–∂–∏—Ç–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ', 'error'); return; }

  // Add to incoming history
  var incoming = getIncoming();
  incoming.unshift({ id:genId(), date:date, product:rawVal, qty:qty, supplier:supplier, note:note });
  setIncoming(incoming);

  // Update product stock
  var products = getProducts();
  // Try to find by matching name (removing emoji prefix)
  products = products.map(function(p) {
    if (rawVal.indexOf(p.name) !== -1) {
      p.stock = (p.stock || 0) + qty;
    }
    return p;
  });
  setProducts(products);

  closeModal('incomingModal');
  showToast('üì• –ü–æ—Å—Ç—É–ø–ª–µ–Ω–∏–µ +' + qty + ' —à—Ç –ø—Ä–∏–Ω—è—Ç–æ');
  renderProducts();
  renderIncoming();
}

/* ================================================================
   SALES
   ================================================================ */
function getSales() { return getData('sales', []); }
function setSales(arr) { setData('sales', arr); }

function renderSales() {
  var sales = getSales();
  var search = document.getElementById('salesSearch').value.toLowerCase();
  var dateFrom = document.getElementById('salesDateFrom').value;
  var dateTo = document.getElementById('salesDateTo').value;
  var filtered = sales.filter(function(s) {
    if (search && s.product.toLowerCase().indexOf(search) === -1 && s.id.toLowerCase().indexOf(search) === -1) return false;
    if (dateFrom && s.date < dateFrom) return false;
    if (dateTo && s.date > dateTo) return false;
    return true;
  });

  document.getElementById('salesCount').textContent = filtered.length;

  // Stats
  var totalRevenue = filtered.reduce(function(a, s) { return a + s.total; }, 0);
  var totalQty = filtered.reduce(function(a, s) { return a + s.qty; }, 0);
  var avgCheck = filtered.length ? Math.round(totalRevenue / filtered.length) : 0;
  document.getElementById('salesStats').innerHTML =
    statCard('üí∞', 'amber', formatMoney(totalRevenue), '–í—ã—Ä—É—á–∫–∞') +
    statCard('üì¶', 'blue', totalQty, '–ü—Ä–æ–¥–∞–Ω–æ (—à—Ç)') +
    statCard('üßæ', 'green', filtered.length, '–¢—Ä–∞–Ω–∑–∞–∫—Ü–∏–π') +
    statCard('üìä', 'purple', formatMoney(avgCheck), '–°—Ä–µ–¥–Ω–∏–π —á–µ–∫');

  var tbody = document.getElementById('salesBody');
  if (filtered.length === 0) {
    tbody.innerHTML = '<tr><td colspan="8" class="table-empty">–ù–µ—Ç –ø—Ä–æ–¥–∞–∂</td></tr>';
    return;
  }
  tbody.innerHTML = filtered.map(function(s) {
    return '<tr>' +
      '<td class="text-muted" style="font-size:11px">' + s.id + '</td>' +
      '<td>' + formatDate(s.date) + '</td>' +
      '<td><strong>' + s.product + '</strong></td>' +
      '<td>' + s.qty + '</td>' +
      '<td>' + formatMoney(s.price) + '</td>' +
      '<td class="text-bold text-amber">' + formatMoney(s.total) + '</td>' +
      '<td><span class="status gray">' + s.payment + '</span></td>' +
      '<td><button class="btn-icon danger" onclick="deleteSale(\'' + s.id + '\')" title="–£–¥–∞–ª–∏—Ç—å">üóëÔ∏è</button></td>' +
    '</tr>';
  }).join('');
}

document.getElementById('salesSearch').addEventListener('input', renderSales);
document.getElementById('salesDateFrom').addEventListener('change', renderSales);
document.getElementById('salesDateTo').addEventListener('change', renderSales);

function openSaleModal() {
  var products = getProducts();
  var sel = document.getElementById('saleProduct');
  sel.innerHTML = products.map(function(p) {
    return '<option value="' + p.id + '" data-price="' + p.price + '">' + (p.emoji||'') + ' ' + p.name + ' ‚Äî ' + p.price + '‚ÇΩ (–æ—Å—Ç: ' + p.stock + ')</option>';
  }).join('');
  document.getElementById('saleQty').value = 1;
  document.getElementById('saleDate').value = today();
  document.getElementById('salePayment').value = '–ö–∞—Ä—Ç–∞';
  updateSalePrice();
  openModal('saleModal');
}

function updateSalePrice() {
  var sel = document.getElementById('saleProduct');
  var opt = sel.options[sel.selectedIndex];
  if (opt) document.getElementById('salePrice').value = opt.getAttribute('data-price');
  updateSaleTotal();
}

function updateSaleTotal() {
  var qty = Number(document.getElementById('saleQty').value) || 0;
  var price = Number(document.getElementById('salePrice').value) || 0;
  document.getElementById('saleTotalDisplay').textContent = formatMoney(qty * price);
}

function saveSale() {
  var sel = document.getElementById('saleProduct');
  var opt = sel.options[sel.selectedIndex];
  if (!opt) { showToast('–í—ã–±–µ—Ä–∏—Ç–µ —Ç–æ–≤–∞—Ä', 'error'); return; }
  var productId = sel.value;
  var productName = opt.textContent.split(' ‚Äî ')[0].trim();
  var qty = Number(document.getElementById('saleQty').value);
  var price = Number(document.getElementById('salePrice').value);
  var payment = document.getElementById('salePayment').value;
  var date = document.getElementById('saleDate').value || today();

  if (!qty || qty <= 0 || !price) { showToast('–£–∫–∞–∂–∏—Ç–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∏ —Ü–µ–Ω—É', 'error'); return; }

  // Check stock
  var products = getProducts();
  var prod = products.find(function(p) { return p.id === productId; });
  if (prod && prod.stock < qty) {
    showToast('‚ö†Ô∏è –ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Ç–æ–≤–∞—Ä–∞! –û—Å—Ç–∞—Ç–æ–∫: ' + prod.stock, 'error');
    return;
  }

  // Reduce stock
  if (prod) {
    products = products.map(function(p) {
      if (p.id === productId) p.stock = Math.max(0, p.stock - qty);
      return p;
    });
    setProducts(products);
  }

  var sales = getSales();
  sales.unshift({
    id: genId(), date: date, product: productName, qty: qty,
    price: price, total: price * qty, payment: payment
  });
  setSales(sales);

  closeModal('saleModal');
  showToast('üí∞ –ü—Ä–æ–¥–∞–∂–∞ –æ—Ñ–æ—Ä–º–ª–µ–Ω–∞: ' + formatMoney(price * qty));
  renderSales();
  renderProducts();
}

function deleteSale(id) {
  if (!confirm('–£–¥–∞–ª–∏—Ç—å —ç—Ç—É –ø—Ä–æ–¥–∞–∂—É?')) return;
  setSales(getSales().filter(function(s) { return s.id !== id; }));
  showToast('üóëÔ∏è –ü—Ä–æ–¥–∞–∂–∞ —É–¥–∞–ª–µ–Ω–∞');
  renderSales();
}

function exportSales() {
  downloadJSON('sales_' + today() + '.json', getSales());
  showToast('üìã –ü—Ä–æ–¥–∞–∂–∏ —ç–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω—ã');
}

/* ================================================================
   DELIVERY
   ================================================================ */
function getDeliveries() { return getData('deliveries', []); }
function setDeliveries(arr) { setData('deliveries', arr); }

var STATUSES = {
  'new': { label:'–ù–æ–≤—ã–π', cls:'blue', emoji:'üÜï' },
  'assembling': { label:'–°–±–æ—Ä–∫–∞', cls:'yellow', emoji:'üì¶' },
  'shipping': { label:'–í –ø—É—Ç–∏', cls:'purple', emoji:'üöó' },
  'delivered': { label:'–î–æ—Å—Ç–∞–≤–ª–µ–Ω', cls:'green', emoji:'‚úÖ' },
  'cancelled': { label:'–û—Ç–º–µ–Ω—ë–Ω', cls:'red', emoji:'‚ùå' }
};
var STATUS_ORDER = ['new','assembling','shipping','delivered'];

function renderDeliveries() {
  var list = getDeliveries();
  var search = document.getElementById('deliverySearch').value.toLowerCase();
  var statusFilter = document.getElementById('deliveryStatusFilter').value;
  var filtered = list.filter(function(d) {
    if (statusFilter && d.status !== statusFilter) return false;
    if (search) {
      var haystack = (d.id + d.client + d.address + d.items + d.employee).toLowerCase();
      if (haystack.indexOf(search) === -1) return false;
    }
    return true;
  });

  document.getElementById('deliveryCount').textContent = filtered.length;

  // Badge
  var activeCount = list.filter(function(d) { return d.status !== 'delivered' && d.status !== 'cancelled'; }).length;
  document.getElementById('deliveryBadge').textContent = activeCount || '';

  // Stats
  var newCount = list.filter(function(d) { return d.status === 'new'; }).length;
  var assemblingCount = list.filter(function(d) { return d.status === 'assembling'; }).length;
  var shippingCount = list.filter(function(d) { return d.status === 'shipping'; }).length;
  var deliveredCount = list.filter(function(d) { return d.status === 'delivered'; }).length;

  document.getElementById('deliveryStats').innerHTML =
    statCard('üÜï', 'blue', newCount, '–ù–æ–≤—ã–µ') +
    statCard('üì¶', 'amber', assemblingCount, '–°–±–æ—Ä–∫–∞') +
    statCard('üöó', 'purple', shippingCount, '–í –ø—É—Ç–∏') +
    statCard('‚úÖ', 'green', deliveredCount, '–î–æ—Å—Ç–∞–≤–ª–µ–Ω–æ');

  var tbody = document.getElementById('deliveryBody');
  if (filtered.length === 0) {
    tbody.innerHTML = '<tr><td colspan="8" class="table-empty">–ù–µ—Ç –¥–æ—Å—Ç–∞–≤–æ–∫</td></tr>';
    return;
  }

  tbody.innerHTML = filtered.map(function(d) {
    var st = STATUSES[d.status] || STATUSES['new'];
    var timeline = renderTimeline(d.status);
    return '<tr>' +
      '<td class="text-muted" style="font-size:11px">' + d.id + '</td>' +
      '<td>' + formatDate(d.date) + '</td>' +
      '<td><strong>' + d.client + '</strong><br><span class="text-muted" style="font-size:11px">' + d.phone + '</span></td>' +
      '<td style="max-width:200px;font-size:12px">' + d.address + '<br><span class="text-muted" style="font-size:11px">' + d.items + '</span></td>' +
      '<td class="text-bold">' + formatMoney(d.sum) + '</td>' +
      '<td><span class="status ' + st.cls + '">' + st.emoji + ' ' + st.label + '</span>' + timeline + '</td>' +
      '<td>' + (d.employee || '<span class="text-muted">‚Äî</span>') + '</td>' +
      '<td class="actions-cell">' +
        (d.status !== 'delivered' && d.status !== 'cancelled' ? '<button class="btn-icon" onclick="advanceDelivery(\'' + d.id + '\')" title="–°–ª–µ–¥—É—é—â–∏–π —Å—Ç–∞—Ç—É—Å">‚è≠Ô∏è</button>' : '') +
        '<button class="btn-icon" onclick="editDelivery(\'' + d.id + '\')" title="–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å">‚úèÔ∏è</button>' +
        '<button class="btn-icon danger" onclick="deleteDelivery(\'' + d.id + '\')" title="–£–¥–∞–ª–∏—Ç—å">üóëÔ∏è</button>' +
      '</td></tr>';
  }).join('');
}

function renderTimeline(status) {
  if (status === 'cancelled') return '';
  var idx = STATUS_ORDER.indexOf(status);
  var html = '<div class="timeline" style="margin-top:6px">';
  for (var i = 0; i < STATUS_ORDER.length; i++) {
    if (i > 0) html += '<div class="timeline-line' + (i <= idx ? ' done' : '') + '"></div>';
    var cls = i < idx ? 'done' : (i === idx ? 'current' : '');
    html += '<div class="timeline-dot ' + cls + '">' + (i < idx ? '‚úì' : (i+1)) + '</div>';
  }
  html += '</div>';
  return html;
}

document.getElementById('deliverySearch').addEventListener('input', renderDeliveries);
document.getElementById('deliveryStatusFilter').addEventListener('change', renderDeliveries);

function openDeliveryModal() {
  document.getElementById('delEditId').value = '';
  document.getElementById('delClient').value = '';
  document.getElementById('delPhone').value = '';
  document.getElementById('delAddress').value = '';
  document.getElementById('delItems').value = '';
  document.getElementById('delSum').value = '';
  document.getElementById('delEmployee').value = '';
  document.getElementById('delStatus').value = 'new';
  document.getElementById('delDate').value = today();
  document.getElementById('delComment').value = '';
  document.getElementById('deliveryModalTitle').textContent = 'üöó –ù–æ–≤–∞—è –¥–æ—Å—Ç–∞–≤–∫–∞';
  openModal('deliveryModal');
}

function editDelivery(id) {
  var d = getDeliveries().find(function(x) { return x.id === id; });
  if (!d) return;
  document.getElementById('delEditId').value = d.id;
  document.getElementById('delClient').value = d.client;
  document.getElementById('delPhone').value = d.phone;
  document.getElementById('delAddress').value = d.address;
  document.getElementById('delItems').value = d.items;
  document.getElementById('delSum').value = d.sum;
  document.getElementById('delEmployee').value = d.employee || '';
  document.getElementById('delStatus').value = d.status;
  document.getElementById('delDate').value = d.date;
  document.getElementById('delComment').value = d.comment || '';
  document.getElementById('deliveryModalTitle').textContent = '‚úèÔ∏è –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –¥–æ—Å—Ç–∞–≤–∫—É';
  openModal('deliveryModal');
}

function saveDelivery() {
  var client = document.getElementById('delClient').value.trim();
  var phone = document.getElementById('delPhone').value.trim();
  var address = document.getElementById('delAddress').value.trim();
  var items = document.getElementById('delItems').value.trim();
  var sum = Number(document.getElementById('delSum').value);
  var employee = document.getElementById('delEmployee').value.trim();
  var status = document.getElementById('delStatus').value;
  var date = document.getElementById('delDate').value || today();
  var comment = document.getElementById('delComment').value.trim();
  var editId = document.getElementById('delEditId').value;

  if (!client || !phone || !address || !items || !sum) {
    showToast('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è', 'error');
    return;
  }

  var deliveries = getDeliveries();
  if (editId) {
    deliveries = deliveries.map(function(d) {
      if (d.id === editId) return { id:d.id, date:date, client:client, phone:phone, address:address, items:items, sum:sum, status:status, employee:employee, comment:comment };
      return d;
    });
    showToast('‚úÖ –î–æ—Å—Ç–∞–≤–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∞');
  } else {
    deliveries.unshift({ id:genId(), date:date, client:client, phone:phone, address:address, items:items, sum:sum, status:status, employee:employee, comment:comment });
    showToast('‚úÖ –î–æ—Å—Ç–∞–≤–∫–∞ —Å–æ–∑–¥–∞–Ω–∞');
  }
  setDeliveries(deliveries);
  closeModal('deliveryModal');
  renderDeliveries();
}

function advanceDelivery(id) {
  var deliveries = getDeliveries();
  deliveries = deliveries.map(function(d) {
    if (d.id === id) {
      var idx = STATUS_ORDER.indexOf(d.status);
      if (idx < STATUS_ORDER.length - 1) {
        d.status = STATUS_ORDER[idx + 1];
      }
    }
    return d;
  });
  setDeliveries(deliveries);
  showToast('‚è≠Ô∏è –°—Ç–∞—Ç—É—Å –æ–±–Ω–æ–≤–ª—ë–Ω');
  renderDeliveries();
}

function deleteDelivery(id) {
  if (!confirm('–£–¥–∞–ª–∏—Ç—å —ç—Ç—É –¥–æ—Å—Ç–∞–≤–∫—É?')) return;
  setDeliveries(getDeliveries().filter(function(d) { return d.id !== id; }));
  showToast('üóëÔ∏è –î–æ—Å—Ç–∞–≤–∫–∞ —É–¥–∞–ª–µ–Ω–∞');
  renderDeliveries();
}

function exportDeliveries() {
  downloadJSON('deliveries_' + today() + '.json', getDeliveries());
  showToast('üìã –î–æ—Å—Ç–∞–≤–∫–∏ —ç–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω—ã');
}

/* ================================================================
   DASHBOARD
   ================================================================ */
function renderDashboard() {
  var products = getProducts();
  var sales = getSales();
  var deliveries = getDeliveries();

  var totalRevenue = sales.reduce(function(a, s) { return a + s.total; }, 0);
  var totalProducts = products.length;
  var totalSales = sales.length;
  var activeDeliveries = deliveries.filter(function(d) { return d.status !== 'delivered' && d.status !== 'cancelled'; }).length;

  document.getElementById('dashStats').innerHTML =
    statCard('üí∞', 'amber', formatMoney(totalRevenue), '–û–±—â–∞—è –≤—ã—Ä—É—á–∫–∞', '+12%', 'up') +
    statCard('üì¶', 'blue', totalProducts, '–¢–æ–≤–∞—Ä–æ–≤', '', '') +
    statCard('üßæ', 'green', totalSales, '–ü—Ä–æ–¥–∞–∂', '+8%', 'up') +
    statCard('üöó', 'purple', activeDeliveries, '–ê–∫—Ç–∏–≤–Ω—ã—Ö –¥–æ—Å—Ç–∞–≤–æ–∫', '', '');

  // Last 5 sales
  var tbody1 = document.getElementById('dashSalesBody');
  var recentSales = sales.slice(0, 5);
  if (recentSales.length === 0) {
    tbody1.innerHTML = '<tr><td colspan="4" class="table-empty">–ù–µ—Ç –ø—Ä–æ–¥–∞–∂</td></tr>';
  } else {
    tbody1.innerHTML = recentSales.map(function(s) {
      return '<tr><td>' + s.product + '</td><td>' + s.qty + '</td><td class="text-bold text-amber">' + formatMoney(s.total) + '</td><td>' + formatDate(s.date) + '</td></tr>';
    }).join('');
  }

  // Active deliveries
  var tbody2 = document.getElementById('dashDeliveryBody');
  var activeDels = deliveries.filter(function(d) { return d.status !== 'delivered' && d.status !== 'cancelled'; }).slice(0, 5);
  if (activeDels.length === 0) {
    tbody2.innerHTML = '<tr><td colspan="4" class="table-empty">–ù–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö</td></tr>';
  } else {
    tbody2.innerHTML = activeDels.map(function(d) {
      var st = STATUSES[d.status];
      return '<tr><td class="text-muted" style="font-size:11px">' + d.id + '</td><td>' + d.client + '</td><td><span class="status ' + st.cls + '">' + st.emoji + ' ' + st.label + '</span></td><td>' + (d.employee || '‚Äî') + '</td></tr>';
    }).join('');
  }

  // Low stock
  var tbody3 = document.getElementById('dashLowStockBody');
  var lowStock = products.filter(function(p) { return p.stock < 10; }).sort(function(a,b) { return a.stock - b.stock; });
  if (lowStock.length === 0) {
    tbody3.innerHTML = '<tr><td colspan="4" class="table-empty">–í—Å–µ —Ç–æ–≤–∞—Ä—ã –≤ –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–µ üëç</td></tr>';
  } else {
    tbody3.innerHTML = lowStock.map(function(p) {
      var cls = p.stock === 0 ? 'red' : 'yellow';
      return '<tr><td><strong>' + (p.emoji||'') + ' ' + p.name + '</strong></td><td>' + p.cat + '</td><td><span class="status ' + cls + '">' + p.stock + ' —à—Ç</span></td><td>' + formatMoney(p.price) + '</td></tr>';
    }).join('');
  }
}

function statCard(emoji, color, value, label, change, dir) {
  return '<div class="stat-card"><div class="top"><div class="icon ' + color + '">' + emoji + '</div>' +
    (change ? '<span class="change ' + dir + '">' + change + '</span>' : '') +
    '</div><h3>' + value + '</h3><div class="label">' + label + '</div></div>';
}

/* ================================================================
   SETTINGS
   ================================================================ */
function loadAIConfig() {
  var cfg = getData('ai_config', {});
  document.getElementById('cfgEnabled').value = cfg.enabled ? 'true' : 'false';
  document.getElementById('cfgUrl').value = cfg.apiUrl || 'https://openrouter.ai/api/v1/chat/completions';
  document.getElementById('cfgModel').value = cfg.model || 'z-ai/glm-4.5-air:free';
  document.getElementById('cfgKey').value = cfg.apiKey || '';
  document.getElementById('cfgTokens').value = cfg.maxTokens || 300;
}

function saveAIConfig() {
  var cfg = {
    enabled: document.getElementById('cfgEnabled').value === 'true',
    apiUrl: document.getElementById('cfgUrl').value.trim(),
    model: document.getElementById('cfgModel').value.trim(),
    apiKey: document.getElementById('cfgKey').value.trim(),
    maxTokens: Number(document.getElementById('cfgTokens').value) || 300
  };
  setData('ai_config', cfg);
  showToast('üíæ –ù–∞—Å—Ç—Ä–æ–π–∫–∏ AI —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã');
}

async function testAI() {
  var result = document.getElementById('aiTestResult');
  result.style.display = 'block';
  result.textContent = '‚è≥ –û—Ç–ø—Ä–∞–≤–ª—è—é —Ç–µ—Å—Ç–æ–≤—ã–π –∑–∞–ø—Ä–æ—Å...';
  result.style.background = '#fffbeb';

  var cfg = {
    apiUrl: document.getElementById('cfgUrl').value.trim(),
    model: document.getElementById('cfgModel').value.trim(),
    apiKey: document.getElementById('cfgKey').value.trim(),
    maxTokens: 100
  };

  if (!cfg.apiKey) {
    result.textContent = '‚ùå –í–≤–µ–¥–∏—Ç–µ API –∫–ª—é—á';
    result.style.background = '#fef2f2';
    return;
  }

  try {
    var res = await fetch(cfg.apiUrl, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + cfg.apiKey },
      body: JSON.stringify({
        model: cfg.model,
        messages: [
          { role: 'system', content: '–¢—ã —Ç–µ—Å—Ç–æ–≤—ã–π –±–æ—Ç. –û—Ç–≤–µ—Ç—å –æ–¥–Ω–∏–º –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ–º.' },
          { role: 'user', content: '–ü—Ä–∏–≤–µ—Ç! –°–∫–∞–∂–∏ —á—Ç–æ-–Ω–∏–±—É–¥—å –¥–ª—è —Ç–µ—Å—Ç–∞.' }
        ],
        max_tokens: cfg.maxTokens
      })
    });
    if (!res.ok) throw new Error('HTTP ' + res.status + ': ' + (await res.text()));
    var data = await res.json();
    var answer = data.choices && data.choices[0] && data.choices[0].message && data.choices[0].message.content;
    result.textContent = '‚úÖ –û—Ç–≤–µ—Ç AI: ' + (answer || '–ø—É—Å—Ç–æ–π –æ—Ç–≤–µ—Ç');
    result.style.background = '#f0fdf4';
  } catch(e) {
    result.textContent = '‚ùå –û—à–∏–±–∫–∞: ' + e.message;
    result.style.background = '#fef2f2';
  }
}

/* ================================================================
   EXPORT / IMPORT
   ================================================================ */
function downloadJSON(filename, data) {
  var blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
  var a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = filename;
  a.click();
  URL.revokeObjectURL(a.href);
}

function exportAllData() {
  var all = {
    products: getProducts(),
    sales: getSales(),
    deliveries: getDeliveries(),
    incoming: getIncoming(),
    ai_config: getData('ai_config', {}),
    exportDate: new Date().toISOString()
  };
  downloadJSON('brew_bean_backup_' + today() + '.json', all);
  showToast('üì• –í—Å–µ –¥–∞–Ω–Ω—ã–µ —ç–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω—ã');
}

function importAllData(event) {
  var file = event.target.files[0];
  if (!file) return;
  var reader = new FileReader();
  reader.onload = function(e) {
    try {
      var data = JSON.parse(e.target.result);
      if (data.products) setData('products', data.products);
      if (data.sales) setData('sales', data.sales);
      if (data.deliveries) setData('deliveries', data.deliveries);
      if (data.incoming) setData('incoming', data.incoming);
      if (data.ai_config) setData('ai_config', data.ai_config);
      showToast('üì§ –î–∞–Ω–Ω—ã–µ –∏–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω—ã');
      refreshPage(currentPage);
    } catch(err) {
      showToast('‚ùå –û—à–∏–±–∫–∞ —á—Ç–µ–Ω–∏—è —Ñ–∞–π–ª–∞', 'error');
    }
  };
  reader.readAsText(file);
  event.target.value = '';
}

function clearAllData() {
  if (!confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã? –í—Å–µ –¥–∞–Ω–Ω—ã–µ –±—É–¥—É—Ç —É–¥–∞–ª–µ–Ω—ã!')) return;
  if (!confirm('–¢–û–ß–ù–û —É–¥–∞–ª–∏—Ç—å –í–°–ï –¥–∞–Ω–Ω—ã–µ? –≠—Ç–æ –Ω–µ–æ–±—Ä–∞—Ç–∏–º–æ!')) return;
  localStorage.removeItem('bb_products');
  localStorage.removeItem('bb_sales');
  localStorage.removeItem('bb_deliveries');
  localStorage.removeItem('bb_incoming');
  localStorage.removeItem('bb_initialized');
  showToast('üóëÔ∏è –í—Å–µ –¥–∞–Ω–Ω—ã–µ –æ—á–∏—â–µ–Ω—ã');
  initDemoData();
  refreshPage(currentPage);
}

/* ================================================================
   REFRESH
   ================================================================ */
function refreshPage(page) {
  switch(page) {
    case 'dashboard': renderDashboard(); break;
    case 'products': renderProducts(); renderIncoming(); break;
    case 'sales': renderSales(); break;
    case 'delivery': renderDeliveries(); break;
    case 'settings': loadAIConfig(); break;
  }
}

// Initial render
refreshPage('dashboard');

</script>
</body>
</html>